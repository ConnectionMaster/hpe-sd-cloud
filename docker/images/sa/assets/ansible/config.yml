---
- hosts: localhost
  pre_tasks:
    - name: Set correct ACTIVATOR_DB_VENDOR in setenv
      replace:
        path: /opt/OV/ServiceActivator/bin/setenv
        regexp: ^ACTIVATOR_DB_VENDOR=.*$
        replace: ACTIVATOR_DB_VENDOR={{activator_conf_db_vendor}}
  roles:
    - activator-config
  tasks:
    - name: Create database migration script
      copy:
        dest: /docker/scripts/setup/01_migrate_db.sh
        content: |
          echo "Migrating database if necessary..."
          (
            cd {{activator_patch_dest}}/bin
            ksh patchmanager pm dbinstallUnattended \
              -migrateDatabase \
              -saDbUser {{activator_db_user}} \
              -saDbPassword {{activator_db_password}}
          )
